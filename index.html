<html>

    <head>
        <title>Pokemon Pearler Scaler</title>

        <style type="text/css">
            .side_by_side {
                display: flex;
                flex-direction: row
            }

            .canvas_layers{
                position: relative;
            }
            .canvas_layers .canvas_layer {
                position:absolute;
                left:0;
                top:0;
            }

            #legend_container div{
                display:block;
            }

            #legend_container .color_swatch{
                width: 1em;
                display: inline-block;
                border: solid 1px black;
                margin-right:5px;
                text-align: center;
            }

            #legend_container .color_index.dark{
                color: rgb(0, 0, 0);
            }
            #legend_container .color_index.light{
                color: rgb(255, 255, 255);
            }
        </style>

        <script>
            /////////////////
            // Constants
            /////////////////
            const GRID_SIZE = 22;
            const GRID_SIZE_HALF = 11;

            ////////////////////
            // Variables
            ///////////////////
            var backCanvas = document.createElement('canvas');

            /////////////////////////
            //DOM manipulation
            /////////////////////////
            window.onload = function() {
                document.getElementById("uploadpattern").addEventListener("change", drawpattern, false);
                document.getElementById("uploadsprite").addEventListener("change", drawsprite, false);
                document.getElementById("canvas_debug").addEventListener('click', canvas_click, false);
                document.addEventListener('keypress', canvas_nudge, false)
            };

            function set_scale_onclick(grid_to_color, canvas_scale){
                let onclick = function(){
                    let scale = document.getElementById('scale_input').value
                    let grid_w = document.getElementById('grid_w_input').value
                    let grid_h = document.getElementById('grid_h_input').value
                    do_scale(grid_w, grid_h, scale, grid_to_color, canvas_scale); 
                }

                document.getElementById('scale_button').addEventListener('click', onclick, false)
            }

            function set_scale_options(grid_w, grid_h){
                document.getElementById('grid_w_input').value = grid_w;
                document.getElementById('grid_h_input').value = grid_h;
            }

            let resize_canvas = function(canvas_id, width, height){
                canvas = document.getElementById(canvas_id);
                canvas_debug = document.getElementById(canvas_id+"_debug");

                canvas.height = height;
                canvas.width = width;
                if (canvas_debug){
                    canvas_debug.height = height;
                    canvas_debug.width = width;
                }
            }

            /////////////////////////
            //Color Legend
            ////////////////////////

            COLOR_INDEX = new Map();
            COLOR_LEGEND = new Map();
            function legend_clear(){
                COLOR_LEGEND.clear();
                COLOR_INDEX.clear();
            }

            function legend_add(r,g,b){
                key = [r,g,b].join(",")
                const current = COLOR_LEGEND.get(key);
                COLOR_LEGEND.set(key, (current || 0) + 1);

                index = COLOR_INDEX.get(key);
                if(!index){
                    COLOR_INDEX.set( key, COLOR_INDEX.size + 1 );
                    index = COLOR_INDEX.get(key);
                }
                return index;
            }

            function legend_render(){
                const legend_container = document.getElementById("legend_container");

                const newLegend = [];
                COLOR_LEGEND.forEach((value, key) => {
                    const color_line = document.createElement("div");
                    const color_swatch = document.createElement("span");
                    const color_index = document.createElement("span");
                    const color_count = document.createElement("span");
                    color_line.append(color_swatch);
                    color_line.append(color_count);
                    color_swatch.append(color_index);
                    newLegend.push(color_line);

                    color_count.innerHTML = value;

                    color_swatch.style.backgroundColor = `rgb(${key})`;
                    color_swatch.setAttribute('class', 'color_swatch');

                    const [r,g,b] = key.split(",").map(Number);
                    
                    color_index.classList.add('color_index');
                    color_index.classList.add( is_light(r,g,b) ? 'light' : 'dark' );
                    
                    color_index.innerHTML = COLOR_INDEX.get(key);

                });

                legend_container.replaceChildren(...newLegend);

            }


            /////////////////////////
            //Source: Image Logic
            /////////////////////////
            function drawpattern(ev) {
                var canvas = document.getElementById('canvas')

                var ctx = canvas.getContext('2d'),
                    img = new Image(),
                    f = document.getElementById("uploadpattern").files[0],
                    url = window.URL || window.webkitURL,
                    src = url.createObjectURL(f);

                img.src = src;

                img.onload = function() {
                    resize_canvas('canvas', this.width, this.height);
                    // consider bringing this down for larger images
                    ctx.drawImage(img, 0, 0);
                    copy_canvas(canvas, backCanvas, 0, 0)
                    url.revokeObjectURL(src);

                    // this lets us use other formats in the future
                    const image_grid_color = function(x, y){
                        const canvas = document.getElementById("canvas");
                        const ctx = canvas.getContext("2d");
                        return get_color_at_grid_point(x, y, ctx);
                    }

                    set_scale_options(canvas.width / GRID_SIZE, canvas.height / GRID_SIZE);
                    set_scale_onclick(image_grid_color);
                }
            }

            function drawsprite(ev) {
                var canvas = document.getElementById('canvas')
                var ctx = canvas.getContext('2d'),
                    img = new Image(),
                    f = document.getElementById("uploadsprite").files[0],
                    url = window.URL || window.webkitURL,
                    src = url.createObjectURL(f);


                    img.src = src;
                    img.onload = function() {
                        resize_canvas('canvas', this.width, this.height);
                        // consider bringing this down for larger images
                        ctx.drawImage(img, 0, 0);
                        url.revokeObjectURL(src);

                    // this lets us use other formats in the future
                    const image_grid_color = function(x, y){
                        const canvas = document.getElementById("canvas");
                        const ctx = canvas.getContext("2d");
                        const pixel_data = ctx.getImageData(x-1, y-1, 1, 1).data;
                        
                        alpha = pixel_data[3]
                        if(alpha > 0){
                            pixel_data[3] = 255;
                        }

                        return pixel_data;
                    }
                    set_scale_options(canvas.width+1, canvas.height+1);
                    set_scale_onclick(image_grid_color, GRID_SIZE * 1.2);
                }
            }

            var get_color_at_grid_point = function(grid_x, grid_y, canvas_context){

                canvas_coords = convert_coords(grid_x, grid_y);
                const pixelData = canvas_context.getImageData(canvas_coords['canvas_x'], canvas_coords['canvas_y'], 1, 1).data;
                return pixelData;
            }


            /////////////////////////
            //Canvas Util
            /////////////////////////
            var convert_coords = function(grid_x, grid_y){
                return {
                    'canvas_x': (grid_x * GRID_SIZE) + GRID_SIZE_HALF,
                    'canvas_y': (grid_y * GRID_SIZE) + GRID_SIZE_HALF
                }
            }

            var grid_coords_from_canvas = function(canvas_x, canvas_y){
                return {
                    'grid_x': Math.floor(canvas_x / GRID_SIZE),
                    'grid_y': Math.floor(canvas_y / GRID_SIZE),
                }
            }

            /////////////////////////
            //Scaler Logic
            /////////////////////////
            var do_scale = function(grid_x_max, grid_y_max, scale, get_color_for_grid, canvas_scale){
                const scale_canvas = document.getElementById("canvas_scale");
                const scale_context = scale_canvas.getContext("2d");

                const scale_debug = document.getElementById("canvas_scale_debug");
                const debug_context = scale_debug.getContext("2d");

                legend_clear();

                if(!canvas_scale){
                    canvas_scale = 1;
                }

                //scale_canvas.width = canvas.width * scale * canvas_scale;
                //scale_canvas.height = canvas.height * scale* canvas_scale;

                resize_canvas('canvas_scale', (Number(grid_x_max)+1) * scale * GRID_SIZE, (Number(grid_y_max)+1) * scale * GRID_SIZE);

                //draw number grid
                for(var grid_x=0; grid_x <= (grid_x_max * scale)+scale; grid_x++){
                    draw_text(grid_x, 0, `${grid_x}`, scale_context);
                }

                for(var grid_y=0; grid_y <= (grid_y_max * scale)+scale; grid_y++){
                    draw_text(0, grid_y, `${grid_y}`, scale_context);
                }

                //draw scale
                for(var grid_x = 1; grid_x<=grid_x_max; grid_x++){
                    for(var grid_y = 1; grid_y<=grid_y_max; grid_y++){
                        const color = get_color_for_grid(grid_x, grid_y);

                        const color_index = legend_add(color[0], color[1], color[2]);
                        generate_scale_coordinates(grid_x, grid_y, scale).forEach(function(scale_coord){
                            draw_rect(scale_coord['scale_x'], scale_coord['scale_y'], color, scale_context);
                            draw_text(scale_coord['scale_x'], scale_coord['scale_y'], ""+color_index,  debug_context);
                        });
                    }
                }

                //draw grid lines
                for(var grid_x=0; grid_x <= (grid_x_max * scale)+scale; grid_x++){
                    draw_line(grid_x, 0, grid_x, (grid_y_max*scale)+scale, scale_context)
                }

                for(var grid_y=0; grid_y <= (grid_y_max * scale)+scale; grid_y++){
                    draw_line(0, grid_y, (grid_x_max*scale)+scale, grid_y, scale_context)
                }

                legend_render();
            }

            var generate_scale_coordinates = function(grid_x, grid_y, scale){


                let x_start = grid_x * scale
                let y_start = grid_y * scale

                const coordinates = []
                for(let scale_x=0; scale_x<scale; scale_x++){
                    for(let scale_y=0; scale_y<scale; scale_y++){
                        coordinates.push({
                            'scale_y': scale_y + y_start,
                            'scale_x': scale_x + x_start
                        })
                    }
                }

                return coordinates;
            }

            /////////////////////////
            //Canvas Logic
            /////////////////////////
            var draw_rect = function(grid_x, grid_y, rgb_array, scale_context){

                canvas_coords = convert_coords(grid_x, grid_y);
                scale_context.fillStyle = `rgba(${rgb_array[0]}, ${rgb_array[1]}, ${rgb_array[2]}, ${rgb_array[3]})`;
                scale_context.fillRect(canvas_coords['canvas_x'], canvas_coords['canvas_y'], GRID_SIZE, GRID_SIZE)
            }

            var draw_rect_border = function(grid_x, grid_y, context){
                canvas_coords = convert_coords(grid_x, grid_y);
                context.save();
                context.beginPath();
                context.lineWidth = "3";
                context.strokeStyle = "red";
                context.rect(canvas_coords['canvas_x'] - GRID_SIZE_HALF, 
                             canvas_coords['canvas_y'] - GRID_SIZE_HALF, GRID_SIZE, GRID_SIZE);
                context.stroke();    
                context.restore();              
            }

            var draw_text = function(grid_x, grid_y, text, scale_context){
                canvas_coords = convert_coords(grid_x, grid_y);
                scale_context.fillText(text, canvas_coords['canvas_x']+7, canvas_coords['canvas_y']+11)
            }
            

            var draw_line = function(grid_x_start, grid_y_start, grid_x_end, grid_y_end, scale_context){

                start_coord = convert_coords(grid_x_start, grid_y_start);
                end_coord = convert_coords(grid_x_end, grid_y_end);
                scale_context.beginPath();
                scale_context.moveTo(start_coord['canvas_x'], start_coord['canvas_y']);
                scale_context.lineTo(end_coord['canvas_x'], end_coord['canvas_y']);

                // Draw the Path
                scale_context.save();
                scale_context.strokeStyle = "white";
                scale_context.stroke();

                scale_context.restore();
                scale_context.strokeStyle = "black";
                scale_context.setLineDash([2, 2]);
                scale_context.stroke();
                scale_context.restore();
            }

            var copy_canvas = function(from_canvas, to_canvas, x, y){
                to_canvas.width = from_canvas.width;
                to_canvas.height = from_canvas.height;
                var to_canvas_context = to_canvas.getContext('2d');
                to_canvas_context.drawImage(from_canvas, x, y);
            }

            var clear_canvas = function(canvas){
                const context = canvas.getContext('2d');
                context.clearRect(0, 0, canvas.width, canvas.height);
            }

            ////////////////////////////////
            //Canvas Click Interactions
            ////////////////////////////////
            let canvas_click = function(ev){
                var rect = ev.target.getBoundingClientRect();
                var x = ev.clientX - rect.left; //x position within the element.
                var y = ev.clientY - rect.top;  //y position within the element.
                var grid = grid_coords_from_canvas(x,y);

                canvas = document.getElementById('canvas_debug');
                clear_canvas(canvas);
                draw_rect_border(grid.grid_x, grid.grid_y, canvas.getContext('2d'));
            }

            let canvas_nudge = function(ev){

                dx = 0;
                dy = 0;
                switch(ev.key) {
                case 'w': //up
                    dy = -1;
                    break;
                case 'a': //left
                    dx = -1;
                    break;
                case 's': //down
                    dy = 1
                    break;
                case 'd': //right
                    dx = 1;
                    break;
                default:
                    // code block
                }

                var backCtx = backCanvas.getContext('2d');
                var canvas = document.getElementById("canvas");
                
                canvas.dataset.dx = (Number(canvas.dataset.dx) || 0) + dx;
                canvas.dataset.dy = (Number(canvas.dataset.dy) || 0) + dy;
                copy_canvas(backCanvas, canvas, Number(canvas.dataset.dx), Number(canvas.dataset.dy))
            }

            /////////////////////
            //Color Logic
            /////////////////////
            function is_light(r,g,b){
                brightness=0.2126*r + 0.7152*g + 0.0722*b;
                return brightness < 128;
            }
        </script>
    </head>

    <body>

        <div class="side_by_side">
            <fieldset>
                <legend>Pattern Input</legend>
                <input type='file' name='img' size='65' id='uploadpattern' />
            </fieldset>

            <fieldset>
                <legend>Sprite Input</legend>
                <input type='file' name='img' size='65' id='uploadsprite' />
            </fieldset>
        </div>

        <div class="side_by_side">
            <fieldset>
                <legend>Scaling Options</legend>
                Scale: <input type="number" id = 'scale_input' name="scale" min="1" value="1"/> <br />
                Grid Width: <input type="number" id='grid_w_input' name="grid_w" min="1"/> <br />
                Grid Height: <input type="number" id='grid_h_input' name="grid_h" min="1" /> <br />
                <input type="button" id="scale_button" value="Scale" />
            </fieldset>
            <fieldset>
                <legend>Color Debug</legend>
            </fieldset>
        </div>

        <div class="side_by_side">
            <fieldset>
                <legend>Original</legend>
                <div class="canvas_layers">
                    <canvas id="canvas" width="500"></canvas>
                    <canvas id="canvas_debug" class="canvas_layer"></canvas>
                </div>
            </fieldset> 

            <fieldset>
                <legend>Scale</legend>
                <div class="canvas_layers">
                    <canvas id="canvas_scale" width="500"></canvas>
                    <canvas id="canvas_scale_debug" class="canvas_layer"></canvas>
                </div>
            </fieldset> 
            <fieldset>
                <legend>Color Legend</legend>
                <div id="legend_container"></div>
            </fieldset>
        </div>

    </body>

</html>