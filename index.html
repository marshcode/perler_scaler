<html>

    <head>
        <title>Pokemon Pearler Scaler</title>

        <script>
            function draw(ev) {
                console.log(ev);
                var canvas = document.getElementById('canvas')

                var ctx = canvas.getContext('2d'),
                    img = new Image(),
                    f = document.getElementById("uploadimage").files[0],
                    url = window.URL || window.webkitURL,
                    src = url.createObjectURL(f);

                img.src = src;

                img.onload = function() {
                    canvas.height = this.height;
                    canvas.width = this.width;
                    // consider bringing this down for larger images
                    ctx.drawImage(img, 0, 0);
                    url.revokeObjectURL(src);

                    let scale = document.getElementById('scale_input').value
                    let grid_w = document.getElementById('grid_w_input').value
                    let grid_h = document.getElementById('grid_h_input').value

                    grid_w = grid_w || Math.floor(canvas.width / 22);
                    grid_h = grid_h || Math.floor(canvas.height / 22);

                    do_scale(grid_w, grid_h, scale); //TODO: get these from inputs
                }
                //canvas.height = canvas.width * ratio;  
            }

            window.onload = function() {
                document.getElementById("uploadimage").addEventListener("change", draw, false)
            };


            var do_scale = function(grid_x_max, grid_y_max, scale){
                const canvas = document.getElementById("canvas");
                const ctx = canvas.getContext("2d");
                const scale_canvas = document.getElementById("canvas_scale");
                const scale_context = scale_canvas.getContext("2d");


                scale_canvas.width = canvas.width * scale;
                scale_canvas.height = canvas.height * scale;

                //draw number grid
                for(var grid_x=0; grid_x <= (grid_x_max * scale)+scale; grid_x++){
                    draw_text(grid_x, 0, `${grid_x}`, scale_context);
                }

                for(var grid_y=0; grid_y <= (grid_y_max * scale)+scale; grid_y++){
                    draw_text(0, grid_y, `${grid_y}`, scale_context);
                }

                //draw scale
                for(var grid_x = 1; grid_x<=grid_x_max; grid_x++){
                    for(var grid_y = 1; grid_y<=grid_y_max; grid_y++){
                        const color = get_color_at_grid_point(grid_x, grid_y, ctx);
                        console.log("(" + grid_x + ", " + grid_y + "): " + color);

                        generate_scale_coordinates(grid_x, grid_y, scale).forEach(function(scale_coord){
                            draw_scale(scale_coord['scale_x'], scale_coord['scale_y'], color, scale_context);
                        })
                    }
                }

                //draw grid lines
                for(var grid_x=0; grid_x <= (grid_x_max * scale)+scale; grid_x++){
                    draw_line(grid_x, 0, grid_x, (grid_y_max*scale)+scale, scale_context)
                }

                for(var grid_y=0; grid_y <= (grid_y_max * scale)+scale; grid_y++){
                    draw_line(0, grid_y, (grid_x_max*scale)+scale, grid_y, scale_context)
                }
            }


            var get_color_at_grid_point = function(grid_x, grid_y, canvas_context){

                canvas_coords = convert_coords(grid_x, grid_y);
                const pixelData = canvas_context.getImageData(canvas_coords['canvas_x'], canvas_coords['canvas_y'], 1, 1).data;
                return pixelData;
            }

            var convert_coords = function(grid_x, grid_y){
                return {
                    'canvas_x': (grid_x * 22) + 11,
                    'canvas_y': (grid_y * 22) + 11
                }
            }

            var generate_scale_coordinates = function(grid_x, grid_y, scale){


                let x_start = grid_x * scale
                let y_start = grid_y * scale

                const coordinates = []
                for(let scale_x=0; scale_x<scale; scale_x++){
                    for(let scale_y=0; scale_y<scale; scale_y++){
                        coordinates.push({
                            'scale_y': scale_y + y_start,
                            'scale_x': scale_x + x_start
                        })
                    }
                }

                return coordinates;
            }

            var draw_scale = function(grid_x, grid_y, rgb_array, scale_context){

                canvas_coords = convert_coords(grid_x, grid_y);
                scale_context.fillStyle = `rgb(${rgb_array[0]}, ${rgb_array[1]}, ${rgb_array[2]})`;
                scale_context.fillRect(canvas_coords['canvas_x'], canvas_coords['canvas_y'], 22, 22)
            }

            var draw_text = function(grid_x, grid_y, text, scale_context){
                canvas_coords = convert_coords(grid_x, grid_y);
                scale_context.fillText(text, canvas_coords['canvas_x']+7, canvas_coords['canvas_y']+11)
            }
            

            var draw_line = function(grid_x_start, grid_y_start, grid_x_end, grid_y_end, scale_context){

                start_coord = convert_coords(grid_x_start, grid_y_start);
                end_coord = convert_coords(grid_x_end, grid_y_end);
                scale_context.beginPath();
                scale_context.moveTo(start_coord['canvas_x'], start_coord['canvas_y']);
                scale_context.lineTo(end_coord['canvas_x'], end_coord['canvas_y']);

                // Draw the Path
                scale_context.save();
                scale_context.strokeStyle = "white";
                scale_context.stroke();

                scale_context.restore();
                scale_context.strokeStyle = "black";
                scale_context.setLineDash([2, 2]);
                scale_context.stroke();
                scale_context.restore();
            }
        </script>
    </head>

    <body>

        <fieldset>
            <legend>Inputs</legend>
            <input type='file' name='img' size='65' id='uploadimage' />
            Scale: <input type="number" id = 'scale_input' name="scale" min="1" value="2"/>
            Grid Width: <input type="number" id='grid_w_input' name="grid_w" min="1"/>
            Grid Height: <input type="number" id='grid_h_input' name="grid_h" min="1" />
        </fieldset>
        
        <fieldset>
            <legend>Original</legend>
            <canvas id="canvas" width="500"></canvas>
        </fieldset> 

        <fieldset>
            <legend>Scale</legend>
            <canvas id="canvas_scale" width="500"></canvas>
        </fieldset> 
    </body>

</html>