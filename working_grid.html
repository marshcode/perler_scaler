<html>

    <head>
        <title>Working Grid</title>

        <style type="text/css">
            #working_grid{
                position: relative;
            }

            .cell{
                position:absolute;
                display:flex;
                justify-content:center;
                align-items:center;
            }

            .side_by_side {
                display: flex;
                flex-direction: row
            }

            #palette_draw span{
                margin-top:5px;
                display:flex;
                align-items:center;
            }

            #palette_draw{
                margin-left:10px;
            }

            #palette_draw div{

                width: 1em;
                display:flex;
                justify-content:center;
                align-items:center;
                border:solid thin black;
                cursor: pointer;
            }

            .disabled{
                opacity: 10%;
            }
        </style>

        <script>

            var DATA = {};
            var GRID = {};
            var PALETTE = {};
            
            
            var WORKING_GRID;
            var GRID_SELECT;

            var PALETTE_SELECT;
            var PALETTE_DRAW;

            function is_light(r,g,b){
                brightness=0.2126*r + 0.7152*g + 0.0722*b;
                return brightness < 128;
            }

            var create_cell = function(label, color){
                var cell = document.createElement('div');
                cell.style.background = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
                cell.innerHTML = label;
                if(is_light(color[0], color[1], color[2])){
                    cell.style.color = 'white';
                }
                return cell;
            }

            var set_grid = function(x, y, label, color, grid_width){

                var cell = create_cell(label, color);
                cell.className = 'cell'
                cell.style.left = '' + (x*grid_width);
                cell.style.top = '' + (y*grid_width);

                cell.style.width = '' + grid_width;
                cell.style.height = '' + grid_width;



                WORKING_GRID.append(cell);

                var rekt = WORKING_GRID.getBoundingClientRect();
                new_width = Math.max(rekt.width, (x+1) * grid_width);
                WORKING_GRID.style.width = `${new_width}px`
                cell.setAttribute('data-palette-idx', label);

            }

            var handle_upload = function(e){
                const reader = new FileReader();
                reader.onload = function() {
                        json_data = JSON.parse(reader.result)


                        for(var palette in json_data['palettes']){
                            PALETTE[palette] = json_data['palettes'][palette]
                            add_to_select(PALETTE_SELECT, palette);
                        }

                        for(var grid in json_data['grids']){
                            add_to_select(GRID_SELECT, grid);
                            GRID[grid] = json_data['grids'][grid]
                        }

                     };
                reader.readAsText(e.target.files[0]);
            }

            var add_to_select = function(SELECT, label){
                var option = document.createElement('option');
                option.innerHTML = label;

                SELECT.append(option);
            }

            var draw_grid = function(grid_name){

                var grid_data = GRID[grid_name];
                var palette = grid_data['palette']
                var grid_colors = grid_data['data']
                var palette_count = {}

                for(var y=0; y<grid_colors.length; y++){
                    var x_grid = grid_colors[y];
                    for(var x=0; x<x_grid.length; x++){
                        var cell = x_grid[x];
                        var color = PALETTE[palette][cell];
                        palette_count[cell] = (palette_count[cell] || 0) +1;

                        if(cell){
                            set_grid(x, y, cell, color, 25)
                        }
                    }
                }

                draw_palette(palette, palette_count)

            }

            var draw_palette = function(palette, palette_labels){
                PALETTE_DRAW.innerHTML = '';
                palette_labels = palette_labels || {}

                for(palette_id in PALETTE[palette]){
                    container = document.createElement('span');
                    var color = PALETTE[palette][palette_id];
                    var cell = create_cell(palette_id, color);
                    cell.setAttribute('data-palette-id', palette_id)

                    var label = palette_labels[palette_id]
                    container.append(cell);
                    if(label){
                        container.append(" : " + label);
                    }
                    PALETTE_DRAW.append(container);
                }
            }

            window.onload = function(){

                WORKING_GRID = document.getElementById("working_grid");
                GRID_SELECT = document.getElementById("grid_select");
                PALETTE_DRAW = document.getElementById("palette_draw");
                PALETTE_SELECT = document.getElementById('palette_select');

                document.getElementById("upload_pattern").addEventListener("change", handle_upload, false);
                document.getElementById("grid_draw").addEventListener('click', function(){

                    var grid_size = document.getElementById("grid_size").value;
                    var grid = GRID_SELECT.value;
                    draw_grid(grid, grid_size);
                })

                document.getElementById('palette_select').addEventListener('change', function(){
                    draw_palette(PALETTE_SELECT.value);
                })


                PALETTE_DRAW.addEventListener('click', function(e){
                    var palette_id = e.target.getAttribute('data-palette-id')
                    var cells = document.querySelectorAll(`[data-palette-idx="${palette_id}"`);

                    

                    cells.forEach(function(cell){

                        var is_disabled = cell.getAttribute('data-is-disabled') === 'true'

                        if(is_disabled){
                            cell.classList.remove('disabled');
                        } else {
                            cell.classList.add('disabled');
                        }
                        cell.setAttribute('data-is-disabled', is_disabled ? 'false' : 'true');
                    })

                }, false)
            };

        </script>

    </head>


    <body>

    <div class="side_by_side">
        <fieldset>
            <legend>Load Data</legend>
            <input type='file' name='upload_pattern' size='65' id='upload_pattern' />
        </fieldset>
        <fieldset>
            <legend>Grid Data</legend>
            <select id="grid_select"></select>
            <input id="grid_draw" type="button" value="draw" />
            <input type="hidden" id="grid_size" value="25" />
        </fieldset>
        <fieldset>
            <legend>Palettes</legend>
            <select id="palette_select">
                <option disabled selected>Choose an option</option>
            </select>
        </fieldset>
    </div>

    <div class="side_by_side">
        <div id="working_grid"></div>
        <div id="palette_draw"></div>
    </div>



    </body>

</html>