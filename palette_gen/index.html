<html>

    <head>
        <title>Palette Gen</title>


        <style type="text/css">

            #body_container{
                display: flex;
            }

            #image_container{
                display: flex;
                flex-direction: column;
                width:50%
            }
            
            #palette_container{
                width:50%
            }
            img {
                width:500px;
                height:auto;
                border: solid thin black;
                display: None;
            }

            .color_swatch{
                width:  20px;
                height: 20px;
                display: inline-block;
                border: solid thin black;
            }

        </style>

        <script type="text/javascript">

            var PALETTE = {};
            var DATA = {}
            var prefix;
            var id;
            var last_point = []

            function track_mouse(e){
                last_point = [e.pageX, e.pageY]
            }

            function draw_color_at_point(x, y, rgb){
                const span = document.createElement('span');
                span.classList.add('color_swatch');
                span.style.top=y-10;
                span.style.left=x-10;
                span.style.position='absolute';
                span.style.backgroundColor=`rgb(${rgb[0]}, ${rgb[1]},${rgb[2]})`;
                document.body.append(span);
            }

            function draw_color_in_element(rgb, element){
                const span = document.createElement('span');
                span.classList.add('color_swatch');
                span.style.backgroundColor=`rgb(${rgb[0]}, ${rgb[1]},${rgb[2]})`;
                element.appendChild(span);
            }

            function draw_swatches(prefix){
                const keys = Object.keys(PALETTE).filter(k=>k.startsWith(prefix)).sort(function(a,b){
                    a_id = Number(a.split("_")[1])
                    b_id = Number(b.split("_")[1])
                    return a_id - b_id;
                });
                const swatches = document.getElementById('color_swatches');
                swatches.innerHTML=''
                for(k of keys){
                    rgb = PALETTE[k];
                    draw_color_in_element(rgb, swatches);
                }
            }

            function select_change(e){
                image_id = e.target.value
                
                var image_element = document.getElementById(`image_${image_id}`);

                Array.from(document.getElementsByClassName('color_swatch')).forEach(swatch=>{
                    swatch.remove();
                })

                Array.from(document.getElementsByTagName('img')).forEach(img=>{
                    img.style.display='none';
                })

                image_element.style.display='block';
                [prefix, id] = DATA[image_element.id];
                draw_swatches(prefix);

            }

            function color_select(e){
                const color = document.getElementById('color_picker').value;
                const r = parseInt(color.substr(1, 2), 16);
                const g = parseInt(color.substr(3, 2), 16);
                const b = parseInt(color.substr(5, 2), 16);

                PALETTE[`${prefix}_${id}`] = [r,g,b]
                id+=10;

                handle_json(PALETTE);
                draw_color_at_point(last_point[0], last_point[1], [r,g,b])
                draw_swatches(prefix);


            }

            function handle_json(palette){
                const json_str = JSON.stringify(palette, null, 0);
                document.getElementById('palette_json').innerText = json_str.replaceAll("],", '],\n');
                window.localStorage.setItem("palette", json_str);
            }

            window.onload = function() {


                PALETTE = JSON.parse(window.localStorage.getItem("palette") || '{}');  
                handle_json(PALETTE);

                document.getElementById('image_selector').addEventListener('change', select_change)
                document.getElementById('color_picker').addEventListener('change', color_select)
                document.getElementById('image_container').addEventListener('mousemove', track_mouse)

                var image_list = [
                    ["red.jpg", 'R', 10], 

                    ['orange.jpg', "OR", 10],

                    ['yellow_1.jpg', "Y", 10],
                    ['yellow_2.jpg', "Y", 70],

                    ['green_1.jpg', "G", 10],
                    ['green_2.jpg', "G", 70],

                    ['blue_1.jpg', "BL", 0],
                    ['blue_2.jpg', "BL", 60],

                    ['purple_1.jpg', "PR", 0],
                    ['purple_2.jpg', "PR", 60],

                    ['pink_1.jpg', "PK", 0],
                    ['pink_2.jpg', "PK", 60],

                    ['bw_1.jpg', "BW", 10],
                    ['bw_2.jpg', "BW", 70],

                    ['brown_1.jpg', "BR", 0],
                    ['brown_2.jpg', "BR", 60],
                    ['brown_3.jpg', "BR", 120],
                ];

                const image_container = document.getElementById('image_container');


                for(let image of image_list){
                    let [path, prefix, start] = image

                    
                    const image_id = `image_${path}`;
                    const imageElm = document.createElement('img');
                    imageElm.setAttribute('src', `images/${path}`);
                    imageElm.setAttribute('id', `image_${path}`)
                    image_container.append(imageElm);
                    DATA[image_id] = [prefix, start]


                    var select = document.getElementById('image_selector');
                    var option = document.createElement('option');
                    option.value = path;
                    option.text = path;
                    select.appendChild(option);
                }
            }


        </script>

    </head>
    <body>

        <div id="body_container">

            <div id="image_container">
                <select id="image_selector"><option disabled selected>Pick Please</option></select>
                <div id="color_swatches" ></div>
            </div>
            <div id="palette_container">
                <input type="color" id="color_picker">
                <pre id="palette_json"></pre>
            </div>
        </div>

    </body>
</html>